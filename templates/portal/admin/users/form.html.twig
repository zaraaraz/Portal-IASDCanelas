{% extends 'base.html.twig' %}

{% block title %}{{ (isEdit ? 'admin.users.form.title_edit' : 'admin.users.form.title_new')|trans({}, 'dashboard') }} | Portal IASDCanelas{% endblock %}

{% block body %}
    <div>
      {% include 'partials/sidebar-collapse.html.twig' %}
      <div id="content" class="position-relative h-100">
        {% include 'partials/topbar-second.html.twig' %}
        <div class="custom-container">

          {# ── Page Header ── #}
          <div class="row g-6 mb-6">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h3 class="mb-1">{{ (isEdit ? 'admin.users.form.title_edit' : 'admin.users.form.title_new')|trans({}, 'dashboard') }}</h3>
                  <p class="text-secondary mb-0">{{ (isEdit ? 'admin.users.form.subtitle_edit' : 'admin.users.form.subtitle_new')|trans({}, 'dashboard') }}</p>
                </div>
                <a href="{{ path('admin_users_index') }}" class="btn btn-outline-secondary">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-left me-1"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l14 0" /><path d="M5 12l6 6" /><path d="M5 12l6 -6" /></svg>
                  {{ 'admin.users.btn.back_to_list'|trans({}, 'dashboard') }}
                </a>
              </div>
            </div>
          </div>

          {# ── Flash Messages ── #}
          {% for type in ['success', 'danger', 'warning', 'info'] %}
            {% for message in app.flashes(type) %}
              <div class="alert alert-{{ type }} alert-dismissible fade show mb-6" role="alert">
                {{ message|trans({}, 'dashboard') }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endfor %}

          <div class="row g-6">
            {# ── User Preview Card (left) ── #}
            {% if isEdit %}
              <div class="col-xl-4 col-lg-5 col-12">
                <div class="card card-lg">
                  <div class="card-body d-flex flex-column align-items-center text-center gap-4">
                    <img src="{{ asset(user.avatarUrl) }}" alt="{{ user.fullName }}" class="avatar avatar-xxl rounded-circle" />
                    <div>
                      <h4 class="mb-1">{{ user.fullName }}</h4>
                      <p class="text-secondary mb-0">{{ user.email }}</p>
                    </div>
                    <div class="d-flex flex-column gap-2 w-100">
                      <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-secondary">{{ 'admin.users.table.status'|trans({}, 'dashboard') }}</span>
                        <span>
                          {% if user.isActive %}
                            <span class="badge text-success-emphasis bg-success-subtle rounded-2">{{ 'admin.users.table.active'|trans({}, 'dashboard') }}</span>
                          {% else %}
                            <span class="badge text-danger-emphasis bg-danger-subtle rounded-2">{{ 'admin.users.table.inactive'|trans({}, 'dashboard') }}</span>
                          {% endif %}
                        </span>
                      </div>
                      <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-secondary">{{ 'admin.users.form.roles'|trans({}, 'dashboard') }}</span>
                        <span>
                          {% for role in user.roles %}
                            {% set roleEntity = roleMap[role] ?? null %}
                            {% set color = roleEntity ? roleEntity.badgeColor : 'primary' %}
                            {% set name = roleEntity ? roleEntity.displayName : role %}
                            <span class="badge text-{{ color }}-emphasis bg-{{ color }}-subtle rounded-2">{{ name }}</span>
                          {% endfor %}
                        </span>
                      </div>
                      <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-secondary">{{ 'profile.info.last_updated'|trans({}, 'dashboard') }}</span>
                        <span>{{ user.updatedAt|date('d/m/Y H:i') }}</span>
                      </div>
                      <div class="d-flex justify-content-between align-items-center py-2">
                        <span class="text-secondary">{{ 'profile.info.member_since'|trans({}, 'dashboard') }}</span>
                        <span>{{ user.createdAt|date('d/m/Y') }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}

            {# ── Form (right or full) ── #}
            <div class="{{ isEdit ? 'col-xl-8 col-lg-7 col-12' : 'col-12' }}">
              <div class="card card-lg">
                <div class="card-body">
                  <h5 class="mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user-edit me-2"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h3.5" /><path d="M18.42 15.61a2.1 2.1 0 0 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39z" /></svg>
                    {{ (isEdit ? 'admin.users.form.section_edit' : 'admin.users.form.section_new')|trans({}, 'dashboard') }}
                  </h5>

                  {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}
                    <div class="row g-4">
                      <div class="col-md-6">
                        <label class="form-label" for="{{ form.fullName.vars.id }}">{{ 'admin.users.form.full_name'|trans({}, 'dashboard') }}</label>
                        {{ form_widget(form.fullName) }}
                        {{ form_errors(form.fullName) }}
                      </div>
                      <div class="col-md-6">
                        <label class="form-label" for="{{ form.email.vars.id }}">{{ 'admin.users.form.email'|trans({}, 'dashboard') }}</label>
                        {{ form_widget(form.email) }}
                        {{ form_errors(form.email) }}
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <label class="form-label" for="{{ form.plainPassword.vars.id }}">
                          {{ (isEdit ? 'admin.users.form.new_password' : 'admin.users.form.password')|trans({}, 'dashboard') }}
                        </label>
                        {{ form_widget(form.plainPassword) }}
                        {{ form_errors(form.plainPassword) }}
                        {% if isEdit %}
                          <small class="text-secondary">{{ 'admin.users.form.password_hint'|trans({}, 'dashboard') }}</small>
                        {% endif %}
                      </div>
                      <div class="col-md-6">
                        <div class="d-flex align-items-center h-100">
                          <div class="form-check form-switch">
                            {{ form_widget(form.isActive) }}
                            <label class="form-check-label" for="{{ form.isActive.vars.id }}">
                              {{ 'admin.users.form.is_active'|trans({}, 'dashboard') }}
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="mt-4">
                      <label class="form-label d-block">{{ 'admin.users.form.roles'|trans({}, 'dashboard') }}</label>
                      <div class="d-flex flex-wrap gap-3">
                        {% for child in form.roles %}
                          <div class="form-check">
                            {{ form_widget(child, {'attr': {'class': 'form-check-input'}}) }}
                            <label class="form-check-label" for="{{ child.vars.id }}">
                              {{ child.vars.label|trans({}, 'dashboard') }}
                            </label>
                          </div>
                        {% endfor %}
                      </div>
                      {{ form_errors(form.roles) }}
                    </div>

                    <div class="mt-4 d-flex gap-2">
                      <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-device-floppy me-1"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2" /><path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M14 4l0 4l-6 0l0 -4" /></svg>
                        {{ (isEdit ? 'admin.users.btn.save_changes' : 'admin.users.btn.create_user')|trans({}, 'dashboard') }}
                      </button>
                      <a href="{{ path('admin_users_index') }}" class="btn btn-outline-secondary">
                        {{ 'admin.users.btn.cancel'|trans({}, 'dashboard') }}
                      </a>
                    </div>
                  {{ form_end(form) }}
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
{% endblock %}
